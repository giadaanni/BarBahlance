<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BarBalance DEBUG</title>
  <style>
    :root { --bg:#0f1115; --text:#e8e8e8; --muted:#aeb6c7; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;height:100%;}
    #stage{position:fixed;inset:0;display:grid;place-items:center;overflow:hidden;}
    canvas{display:block;touch-action:none;-webkit-user-select:none;user-select:none;border-radius:18px;background:#121625;}
    #debug{
      position:fixed; left:10px; right:10px; bottom:10px;
      background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.15);
      border-radius:12px;
      padding:10px;
      font-size:12px;
      line-height:1.35;
      z-index:9999;
      max-height:38vh;
      overflow:auto;
      white-space:pre-wrap;
    }
    #debug b{color:#fff}
    #hud{
      position:fixed;
      left:max(10px, env(safe-area-inset-left));
      right:max(10px, env(safe-area-inset-right));
      top:max(10px, env(safe-area-inset-top));
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      pointer-events:none;
      z-index:5;
    }
    .pill{
      pointer-events:auto;
      background:rgba(20,24,36,.92);
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px;padding:8px 12px;font-size:13px;
      display:flex;gap:10px;align-items:center;white-space:nowrap;
      backdrop-filter: blur(8px);
    }
  </style>
</head>
<body>
  <div id="stage"><canvas id="c"></canvas></div>

  <div id="hud">
    <div class="pill">
      <span>BarBalance</span>
      <span style="opacity:.6">•</span>
      <span>DEBUG</span>
    </div>
    <div class="pill">
      <span id="status">booting…</span>
    </div>
  </div>

  <div id="debug"><b>DEBUG PANEL</b>\n</div>

  <!-- Matter.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

  <script>
    (function(){
      const dbg = document.getElementById('debug');
      const statusEl = document.getElementById('status');
      const log = (msg) => { dbg.textContent += String(msg) + "\n"; };

      // Catch JS errors on iPhone without console
      window.addEventListener('error', (e) => {
        log("JS ERROR: " + (e.message || e.error || "unknown"));
      });
      window.addEventListener('unhandledrejection', (e) => {
        log("PROMISE REJECTION: " + (e.reason && e.reason.message ? e.reason.message : e.reason));
      });

      log("URL: " + location.href);
      log("UserAgent: " + navigator.userAgent);
      log("Matter present? " + (!!window.Matter));

      if (!window.Matter) {
        statusEl.textContent = "Matter.js NOT loaded";
        log("STOP: Matter.js non è stato caricato dal CDN. Soluzione: scaricalo in repo e linkalo localmente.");
        return;
      }

      statusEl.textContent = "Matter OK, starting…";

      const { Engine, World, Bodies, Body } = Matter;

      const canvas = document.getElementById('c');
      const ctx = canvas.getContext('2d');

      // Minimal safe canvas sizing (2:3)
      function resize(){
        const w = Math.min(window.innerWidth, document.documentElement.clientWidth || window.innerWidth);
        const h = Math.min(window.innerHeight, document.documentElement.clientHeight || window.innerHeight);
        const targetH = Math.min(h, w * (3/2));
        const targetW = targetH * (2/3);
        canvas.style.width = Math.floor(targetW) + "px";
        canvas.style.height = Math.floor(targetH) + "px";
        const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        canvas.width = Math.floor(targetW * dpr);
        canvas.height = Math.floor(targetH * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }
      window.addEventListener('resize', resize, {passive:true});
      resize();

      // Minimal physics sanity check (no gameplay)
      const engine = Engine.create();
      engine.gravity.y = 1;

      const WORLD_W=900, WORLD_H=1350;
      const ground = Bodies.rectangle(WORLD_W/2, WORLD_H+60, WORLD_W+500, 120, {isStatic:true});
      const box = Bodies.rectangle(WORLD_W/2, 200, 80, 80, {restitution:0.2});
      World.add(engine.world, [ground, box]);

      // Draw loop
      let last = performance.now();
      function tick(now){
        const dt = Math.min(0.033, (now-last)/1000);
        last=now;
        Engine.update(engine, dt*1000);

        // Draw background + falling box to prove JS is running
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle="#121625";
        ctx.fillRect(0,0,canvas.clientWidth, canvas.clientHeight);

        // World->screen mapping
        const s = Math.min(canvas.clientWidth/WORLD_W, canvas.clientHeight/WORLD_H);
        const ox = (canvas.clientWidth - WORLD_W*s)/2;
        const oy = (canvas.clientHeight - WORLD_H*s)/2;

        ctx.save();
        ctx.translate(ox, oy);
        ctx.scale(s, s);

        // ground
        ctx.fillStyle="rgba(255,255,255,.12)";
        ctx.fillRect(ground.position.x - (WORLD_W+500)/2, ground.position.y - 60, WORLD_W+500, 120);

        // box
        ctx.save();
        ctx.translate(box.position.x, box.position.y);
        ctx.rotate(box.angle);
        ctx.fillStyle="#d8e2ff";
        ctx.fillRect(-40,-40,80,80);
        ctx.restore();

        ctx.restore();

        requestAnimationFrame(tick);
      }

      statusEl.textContent = "running ✅";
      log("Started render loop. If you see a falling square, JS works.");
      requestAnimationFrame(tick);
    })();
  </script>
</body>
</html>