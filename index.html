<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bar Bahlance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            touch-action: none; /* Impedisce lo scroll su mobile */
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 500px; /* Limite larghezza per desktop */
            margin: 0 auto;
            background: linear-gradient(to bottom, #444, #111);
            border-left: 2px solid #555;
            border-right: 2px solid #555;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        h1 {
            color: #FFD700;
            font-size: 24px;
            text-shadow: 4px 4px #000;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
        }

        .blink {
            animation: blinker 1s linear infinite;
            color: white;
            font-size: 14px;
            margin-top: 20px;
        }

        @keyframes blinker {
            50% { opacity: 0; }
        }

        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto; /* Cattura i click */
            cursor: pointer;
        }

        #score-display {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #fff;
            font-size: 12px;
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>
<body>

<div id="game-container">
    <div id="score-display">LIV: <span id="level-val">1</span></div>
    
    <div id="overlay">
        <h1 id="title-text">BAR<br>BAHLANCE</h1>
        <div class="blink" id="start-text">TAP TO START</div>
    </div>
</div>

<script>
    // --- SETUP DEL MOTORE FISICO ---
    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Constraint = Matter.Constraint,
          Events = Matter.Events,
          Body = Matter.Body,
          Vector = Matter.Vector;

    // Creazione motore
    const engine = Engine.create();
    const world = engine.world;

    // Configurazione container
    const container = document.getElementById('game-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    // Renderer (Visualizzazione)
    const render = Render.create({
        element: container,
        engine: engine,
        options: {
            width: width,
            height: height,
            wireframes: false, // Mettiamo false per vedere i colori
            background: 'transparent'
        }
    });

    // Variabili di Gioco
    let tray;
    let handPivot;
    let gameActive = false;
    let level = 1;
    let objectInterval;
    let winTimeout;
    const objects = []; // Teniamo traccia degli oggetti sul vassoio

    // --- FUNZIONI DI CREAZIONE ---

    // 1. Il Vassoio e la Mano
    function createTraySystem() {
        const trayWidth = width * 0.7;
        const trayHeight = 15;
        
        // Il vassoio (rettangolo)
        tray = Bodies.rectangle(width / 2, height - 150, trayWidth, trayHeight, { 
            friction: 0.8, // Molto attrito per non far scivolare subito tutto
            density: 0.005,
            render: { fillStyle: '#8B4513' }, // Colore marrone
            chamfer: { radius: 5 } // Angoli arrotondati
        });

        // La "Mano" (Punto fisso invisibile al centro)
        const pivotPoint = { x: width / 2, y: height - 120 };
        
        // Creiamo un vincolo "Revolute" (cerniera)
        handPivot = Constraint.create({
            pointA: pivotPoint,
            bodyB: tray,
            pointB: { x: 0, y: 30 }, // Punto di aggancio sul vassoio (spostato in basso per stabilit√†)
            stiffness: 1,
            length: 0,
            render: { visible: true, lineWidth: 5, strokeStyle: '#FFCCAA' } // Colore pelle stilizzato
        });

        Composite.add(world, [tray, handPivot]);
    }

    // 2. Generatore di Oggetti (Bicchieri, Bottiglie)
    function spawnObject() {
        if (!gameActive) return;

        const types = ['beer', 'wine', 'shot'];
        const type = types[Math.floor(Math.random() * types.length)];
        
        let newBody;
        const spawnX = (width / 2) + (Math.random() * 40 - 20); // Leggera variazione casuale X
        const spawnY = -50; // Sopra lo schermo

        if (type === 'beer') {
            // Boccale (Rettangolo tozzo)
            newBody = Bodies.rectangle(spawnX, spawnY, 40, 50, {
                render: { fillStyle: '#F28E1C' }, // Color Birra
                density: 0.002,
                friction: 0.5
            });
        } else if (type === 'wine') {
            // Calice (Trapezio invertito)
            newBody = Bodies.trapezoid(spawnX, spawnY, 30, 40, 1, {
                render: { fillStyle: '#722F37' }, // Color Vino
                density: 0.001,
                friction: 0.3,
                angle: Math.PI // Girato
            });
        } else {
            // Shot (Piccolo)
            newBody = Bodies.rectangle(spawnX, spawnY, 20, 25, {
                render: { fillStyle: '#ddd' },
                density: 0.001
            });
        }

        objects.push(newBody);
        Composite.add(world, newBody);
    }

    // --- CONTROLLI ---
    // Logica: Toccare a destra inclina a destra (applica forza), sinistra inclina a sinistra
    let isTouching = false;
    let touchSide = 0; // -1 sinistra, 1 destra

    function handleInput(x) {
        if (!gameActive) return;
        if (x < width / 2) touchSide = -1;
        else touchSide = 1;
        isTouching = true;
    }

    window.addEventListener('mousedown', (e) => handleInput(e.clientX));
    window.addEventListener('touchstart', (e) => handleInput(e.touches[0].clientX));
    
    window.addEventListener('mouseup', () => { isTouching = false; });
    window.addEventListener('touchend', () => { isTouching = false; });


    // --- GAME LOOP LOGIC ---
    function startGame() {
        // Reset
        Composite.clear(world);
        Engine.clear(engine);
        objects.length = 0;
        level = 1;
        document.getElementById('level-val').innerText = level;
        
        createTraySystem();
        
        // Muri invisibili laterali per non far cadere il vassoio fuori dal mondo (opzionale)
        // Per ora lasciamo libero

        gameActive = true;
        document.getElementById('overlay').style.display = 'none';

        // Loop di spawn oggetti (base)
        startLevel(1);
    }

    function startLevel(lvl) {
        let itemsToSpawn = 2 + lvl; // Livello 1: 3 oggetti, Livello 2: 4 oggetti...
        let spawned = 0;

        objectInterval = setInterval(() => {
            if (!gameActive) { clearInterval(objectInterval); return; }
            spawnObject();
            spawned++;
            if (spawned >= itemsToSpawn) {
                clearInterval(objectInterval);
                checkWinCondition();
            }
        }, 2000); // Un oggetto ogni 2 secondi
    }

    function checkWinCondition() {
        // Dopo aver lanciato tutti gli oggetti, aspetta 5 secondi
        winTimeout = setTimeout(() => {
            if (gameActive) {
                level++;
                document.getElementById('level-val').innerText = level;
                // Pulisce un po' oggetti vecchi o continua? Per ora continua (accumulo)
                startLevel(level);
            }
        }, 5000);
    }

    function gameOver() {
        gameActive = false;
        clearInterval(objectInterval);
        clearTimeout(winTimeout);
        document.getElementById('title-text').innerHTML = "GAME OVER";
        document.getElementById('start-text').innerText = "TAP TO RESTART";
        document.getElementById('overlay').style.display = 'flex';
    }

    // Loop di aggiornamento (update ogni frame)
    Events.on(engine, 'beforeUpdate', function(event) {
        if (!gameActive) return;

        // 1. Gestione Input (Stabilizzazione attiva vs Inclinazione utente)
        // Applichiamo una forza rotazionale (Torque) al vassoio
        if (isTouching) {
            Body.setAngularVelocity(tray, tray.angularVelocity + (0.002 * touchSide));
        } else {
            // Auto-stabilizzazione leggera (smorzamento)
            Body.setAngularVelocity(tray, tray.angularVelocity * 0.95);
        }

        // Limitiamo l'angolo massimo del vassoio per non farlo ribaltare di 360 gradi
        const maxAngle = 0.5; // circa 30 gradi
        if (tray.angle > maxAngle) Body.setAngle(tray, maxAngle);
        if (tray.angle < -maxAngle) Body.setAngle(tray, -maxAngle);

        // 2. Controllo Sconfitta
        // Se un oggetto cade troppo in basso
        objects.forEach(obj => {
            if (obj.position.y > height + 50) {
                gameOver();
            }
        });
    });

    // Avvio iniziale al click
    document.getElementById('overlay').addEventListener('click', () => {
        if (!gameActive) startGame();
    });

    // Avvia renderer e runner
    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

</script>

</body>
</html>