<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bar Bahlance</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background-color: #222; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; font-family: 'Press Start 2P', cursive; }
        #game-container { position: relative; width: 100vh; max-width: 100%; aspect-ratio: 2/3; background-color: #3d2e4d; border: 4px solid #000; }
        canvas { display: block; width: 100%; height: 100%; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; z-index: 10; }
        #start-screen { background: url('./ASSET/BarBahlance_mainScreen.png') no-repeat center center; background-size: cover; pointer-events: auto; cursor: pointer; z-index: 20; }
        .blink-text { margin-top: 65%; color: #fff; text-shadow: 4px 4px 0 #000; animation: blink 1s infinite; font-size: 18px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        #hud { display: none; justify-content: flex-start; padding-top: 20px; color: white; text-shadow: 2px 2px 0 #000; font-size: 14px; }
        #countdown { font-size: 40px; color: yellow; display: none; margin-top: 20px; }
        #game-over-screen { background: rgba(0, 0, 0, 0.85); display: none; pointer-events: auto; z-index: 30; }
        .btn { background: #ffcc00; border: 4px solid #fff; padding: 15px 30px; font-family: 'Press Start 2P', cursive; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen" class="ui-layer" onclick="startGame()">
        <div class="blink-text">TAP TO START</div>
    </div>
    <div id="hud" class="ui-layer">
        <div id="level-display">LEVEL 1</div>
        <div id="items-display">Items: 0/3</div>
        <div id="countdown">8</div>
    </div>
    <div id="game-over-screen" class="ui-layer">
        <h1 style="color: red; text-shadow: 3px 3px 0 #000;">CRASH!</h1>
        <button class="btn" onclick="resetGame()">RETRY</button>
    </div>
</div>

<script>
    const { Engine, Render, Runner, Bodies, Composite, Events, Body, Constraint } = Matter;

    let engine, render, runner, tray, pivot;
    let items = [], currentLevelIdx = 0, spawnedCount = 0, isGameOver = false;
    const width = 600, height = 900;
    const LEVELS = [3, 5, 8, 12, 15];
    let targetX = width / 2;

    function init() {
        engine = Engine.create();
        const container = document.getElementById('game-container');
        
        render = Render.create({
            element: container,
            engine: engine,
            options: { width: width, height: height, wireframes: false, background: 'transparent' }
        });

        runner = Runner.create();
        
        const updateInput = (e) => {
            const rect = render.canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            targetX = (clientX - rect.left) * (width / rect.width);
        };

        window.addEventListener('mousemove', updateInput);
        window.addEventListener('touchmove', updateInput, {passive: false});

        Events.on(render, 'afterRender', () => {
            if (isGameOver) return;
            drawHand();
            checkLoseCondition();
            // Il pivot segue il mouse in modo fluido
            if (pivot) pivot.pointA.x = targetX;
        });
    }

    function setupLevel() {
        Composite.clear(engine.world);
        items = []; isGameOver = false;
        document.getElementById('hud').style.display = 'flex';
        document.getElementById('countdown').style.display = 'none';
        
        // VASSOIO: Corpo fisico reattivo
        tray = Bodies.rectangle(width / 2, height - 300, 420, 25, { 
            density: 0.01, friction: 0.5, restitution: 0.1,
            render: { fillStyle: '#bdc3c7' }
        });

        // Perno che collega il mondo al vassoio nel punto centrale
        pivot = Constraint.create({
            pointA: { x: width / 2, y: height - 300 },
            bodyB: tray,
            stiffness: 1, 
            length: 0,
            render: { visible: false }
        });

        Composite.add(engine.world, [tray, pivot]);
        Render.run(render);
        Runner.run(runner, engine);
        spawnedCount = 0;
        startSpawning();
    }

    function spawnItem() {
        const startX = (width / 2) + (Math.random() * 300 - 150);
        const type = Math.floor(Math.random() * 6);
        let item;
        const props = { friction: 0.4, restitution: 0.1, density: 0.02 };

        switch(type) {
            case 0: // Calice
                item = Body.create({ parts: [
                    Bodies.trapezoid(startX, -100, 65, 60, 0.5, { render: { fillStyle: '#900020' }}),
                    Bodies.rectangle(startX, -60, 10, 40, { render: { fillStyle: '#fff' }}),
                    Bodies.rectangle(startX, -40, 50, 10, { render: { fillStyle: '#fff' }})
                ], ...props });
                break;
            case 1: // Boccale
                item = Body.create({ parts: [
                    Bodies.rectangle(startX, -50, 80, 100, { render: { fillStyle: '#f28e1c' }}),
                    Bodies.rectangle(startX + 40, -50, 20, 50, { render: { fillStyle: '#eee' }})
                ], ...props, density: 0.03 });
                break;
            case 2: // Gin Lemon
                item = Bodies.rectangle(startX, -50, 65, 85, { ...props, render: { fillStyle: '#ffff00' }});
                break;
            case 3: // Acqua
                item = Bodies.rectangle(startX, -50, 45, 95, { ...props, render: { fillStyle: '#3498db' }});
                break;
            case 4: // Birra Bottiglia
                item = Body.create({ parts: [
                    Bodies.rectangle(startX, -50, 50, 120, { render: { fillStyle: '#3d2b1f' }}),
                    Bodies.rectangle(startX, -125, 20, 50, { render: { fillStyle: '#3d2b1f' }})
                ], ...props, density: 0.025 });
                break;
            case 5: // Chupito
                item = Bodies.rectangle(startX, -50, 40, 55, { ...props, density: 0.04, render: { fillStyle: '#e74c3c' }});
                break;
        }
        items.push(item);
        Composite.add(engine.world, item);
    }

    function drawHand() {
        const ctx = render.context;
        ctx.beginPath();
        ctx.moveTo(targetX, height); 
        ctx.lineTo(tray.position.x, tray.position.y); 
        ctx.lineWidth = 50; ctx.strokeStyle = '#e0ac69'; ctx.lineCap = 'round'; ctx.stroke();
    }

    function startSpawning() {
        let interval = setInterval(() => {
            if (isGameOver || spawnedCount >= LEVELS[currentLevelIdx]) { 
                clearInterval(interval); 
                if(!isGameOver) startWinCountdown(); 
                return; 
            }
            spawnItem(); spawnedCount++;
            document.getElementById('items-display').innerText = `Items: ${spawnedCount}/${LEVELS[currentLevelIdx]}`;
        }, 2500);
    }

    function startWinCountdown() {
        let sec = 8;
        const el = document.getElementById('countdown');
        el.style.display = 'block';
        let timer = setInterval(() => {
            if (isGameOver) { clearInterval(timer); return; }
            el.innerText = --sec;
            if (sec <= 0) { clearInterval(timer); currentLevelIdx++; setupLevel(); }
        }, 1000);
    }

    function checkLoseCondition() {
        items.forEach(item => { if (item.position.y > height + 100) gameOver(); });
        if (tray.position.y > height + 200 || Math.abs(tray.angle) > 1.5) gameOver();
    }

    function gameOver() { isGameOver = true; document.getElementById('game-over-screen').style.display = 'flex'; }
    function startGame() { document.getElementById('start-screen').style.display = 'none'; init(); setupLevel(); }
    function resetGame() { document.getElementById('game-over-screen').style.display = 'none'; currentLevelIdx = 0; setupLevel(); }
</script>
</body>
</html>
