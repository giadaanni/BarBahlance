<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bar Bahlance</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            max-width: 600px;
            margin: 0 auto;
            background: radial-gradient(circle at center, #333, #111);
            border-left: 2px solid #444;
            border-right: 2px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* UI Elements */
        .hud {
            position: absolute;
            width: 100%;
            pointer-events: none;
            z-index: 10;
            text-align: center;
            color: #fff;
            text-shadow: 2px 2px #000;
        }

        #top-hud {
            top: 20px;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            font-size: 14px;
        }

        #center-msg {
            top: 40%;
            transform: translateY(-50%);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1 {
            color: #FFD700;
            font-size: 30px;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .btn {
            background: #FFD700;
            color: #000;
            padding: 15px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            border: 4px solid #fff;
            cursor: pointer;
            margin-top: 20px;
            pointer-events: auto; /* Abilita click */
            animation: pulse 1.5s infinite;
        }

        .hidden { display: none !important; }

        #countdown-overlay {
            color: #FF4444;
            font-size: 20px;
            margin-top: 50px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>
<body>

<div id="game-container">
    <div id="top-hud" class="hud">
        <div id="level-display">LEVEL: 1</div>
        <div id="items-display">ITEMS: 0/3</div>
    </div>

    <div id="center-msg" class="hud">
        <h1 id="main-title">BAR<br>BAHLANCE</h1>
        <div id="sub-text" style="font-size: 10px; color: #aaa; margin-bottom: 20px;">BALANCE THE TRAY</div>
        <button id="action-btn" class="btn">START GAME</button>
        <div id="countdown-overlay" class="hidden">SURVIVE: <span id="timer-val">8</span></div>
    </div>
</div>

<script>
    // --- MOTORE FISICO ---
    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Constraint = Matter.Constraint,
          Body = Matter.Body,
          Events = Matter.Events;

    // Setup di base
    const engine = Engine.create();
    const world = engine.world;
    const container = document.getElementById('game-container');
    
    // Dimensioni dinamiche
    let width = container.clientWidth;
    let height = container.clientHeight;

    const render = Render.create({
        element: container,
        engine: engine,
        options: {
            width: width,
            height: height,
            wireframes: false,
            background: 'transparent',
            pixelRatio: window.devicePixelRatio // Nitidezza su mobile
        }
    });

    // --- VARIABILI DI GIOCO ---
    let tray, handPivot;
    let currentLevel = 1;
    let itemsSpawned = 0;
    let itemsRequired = 3;
    let gameStatus = "MENU"; // MENU, PLAYING, SURVIVING, GAMEOVER, LEVEL_TRANSITION
    let spawnInterval;
    let surviveTimerInterval;
    let gameObjects = []; // Tiene traccia di bottiglie/bicchieri

    // Configurazione Livelli
    const levels = {
        1: 3,
        2: 5,
        3: 8,
        4: 12,
        5: 15
    };

    // --- CREAZIONE OGGETTI ---

    // 1. Il Vassoio
    function createTray() {
        const trayWidth = Math.min(width * 0.8, 300); // Max 300px larghezza
        const trayHeight = 10;

        tray = Bodies.rectangle(width / 2, height - 200, trayWidth, trayHeight, {
            friction: 0.8,
            frictionStatic: 1.0,
            density: 0.005,
            render: { fillStyle: '#8B4513' },
            chamfer: { radius: 3 },
            collisionFilter: { group: 1 } // Gruppo collisione
        });

        // Perno Mano (invisibile ma renderizzato come linea dal constraint)
        const pivotX = width / 2;
        const pivotY = height - 160;

        handPivot = Constraint.create({
            pointA: { x: pivotX, y: pivotY },
            bodyB: tray,
            pointB: { x: 0, y: 30 }, // Punto di aggancio sotto il vassoio
            stiffness: 0.8, // Un po' rigido ma non troppo
            damping: 0.1,
            length: 0,
            render: { visible: true, lineWidth: 6, strokeStyle: '#E0AC69' } // Colore braccio
        });

        Composite.add(world, [tray, handPivot]);
    }

    // 2. Factory di Forme Complesse
    function spawnItem() {
        if (gameStatus !== "PLAYING") return;
        
        itemsSpawned++;
        updateHUD();

        const randX = (width / 2) + (Math.random() * 60 - 30); // Spawn centrale con variazione
        const startY = -60;
        
        // Scegli tipo a caso
        const type = Math.random();
        let body;

        if (type < 0.33) {
            // BOTTIGLIA DI BIRRA (Corpo + Collo)
            const baseW = 20, baseH = 50;
            const neckW = 8, neckH = 20;
            
            const partA = Bodies.rectangle(randX, startY, baseW, baseH, { render: { fillStyle: '#2E8B57' } }); // Verde
            const partB = Bodies.rectangle(randX, startY - (baseH/2) - (neckH/2), neckW, neckH, { render: { fillStyle: '#2E8B57' } });
            
            body = Body.create({
                parts: [partA, partB],
                friction: 0.4,
                restitution: 0.1 // Rimbalzo basso
            });

        } else if (type < 0.66) {
            // CALICE VINO (Base + Stelo + Coppa a trapezio)
            const stemH = 25;
            const bowlW = 25;
            
            const base = Bodies.rectangle(randX, startY + stemH, 20, 4, { render: { fillStyle: '#eee' } });
            const stem = Bodies.rectangle(randX, startY + (stemH/2), 4, stemH, { render: { fillStyle: '#eee' } });
            const bowl = Bodies.trapezoid(randX, startY, bowlW, 25, 0.8, { 
                render: { fillStyle: '#722F37' }, // Vino
                angle: Math.PI // Girato verso l'alto
            });

            body = Body.create({
                parts: [base, stem, bowl],
                friction: 0.5,
                density: 0.002 // Leggero
            });

        } else {
            // BOCCALE BIRRA (Rettangolo semplice ma largo)
            body = Bodies.rectangle(randX, startY, 30, 40, {
                render: { fillStyle: '#F28E1C', strokeStyle: '#fff', lineWidth: 2 },
                friction: 0.6,
                density: 0.003
            });
        }

        gameObjects.push(body);
        Composite.add(world, body);

        // Controllo fine spawn
        if (itemsSpawned >= itemsRequired) {
            clearInterval(spawnInterval);
            startSurvivalPhase();
        }
    }

    // --- LOGICA DI GIOCO ---

    function initLevel(lvl) {
        // Pulizia
        Composite.clear(world);
        Engine.clear(engine);
        gameObjects = [];
        itemsSpawned = 0;
        
        // Se non esiste il livello, vittoria finale (o loop)
        if (!levels[lvl]) {
            // Loop al livello 5 infinito o vittoria
            itemsRequired = 15; 
        } else {
            itemsRequired = levels[lvl];
        }

        createTray();
        
        gameStatus = "PLAYING";
        document.getElementById('main-title').classList.add('hidden');
        document.getElementById('sub-text').classList.add('hidden');
        document.getElementById('action-btn').classList.add('hidden');
        document.getElementById('countdown-overlay').classList.add('hidden');
        
        updateHUD();

        // Start Spawning
        let spawnRate = Math.max(1000, 2500 - (lvl * 300)); // PiÃ¹ veloce ogni livello
        spawnInterval = setInterval(spawnItem, spawnRate);
    }

    function startSurvivalPhase() {
        gameStatus = "SURVIVING";
        const timerElem = document.getElementById('countdown-overlay');
        const timerVal = document.getElementById('timer-val');
        
        timerElem.classList.remove('hidden');
        let timeLeft = 8;
        timerVal.innerText = timeLeft;

        surviveTimerInterval = setInterval(() => {
            if (gameStatus !== "SURVIVING") {
                clearInterval(surviveTimerInterval);
                return;
            }
            timeLeft--;
            timerVal.innerText = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(surviveTimerInterval);
                levelPassed();
            }
        }, 1000);
    }

    function levelPassed() {
        gameStatus = "LEVEL_TRANSITION";
        document.getElementById('countdown-overlay').innerText = "LEVEL COMPLETE!";
        setTimeout(() => {
            currentLevel++;
            initLevel(currentLevel);
        }, 2000);
    }

    function triggerGameOver() {
        if (gameStatus === "GAMEOVER") return;
        gameStatus = "GAMEOVER";
        
        clearInterval(spawnInterval);
        clearInterval(surviveTimerInterval);

        document.getElementById('main-title').innerHTML = "GAME<br>OVER";
        document.getElementById('main-title').classList.remove('hidden');
        document.getElementById('sub-text').innerText = "THE GLASSES BROKE";
        document.getElementById('sub-text').classList.remove('hidden');
        
        const btn = document.getElementById('action-btn');
        btn.innerText = "TRY AGAIN";
        btn.classList.remove('hidden');
        document.getElementById('countdown-overlay').classList.add('hidden');

        // Reset level progress
        currentLevel = 1;
    }

    function updateHUD() {
        document.getElementById('level-display').innerText = "LEVEL: " + currentLevel;
        document.getElementById('items-display').innerText = "ITEMS: " + itemsSpawned + "/" + itemsRequired;
    }

    // --- CONTROLLI ---
    let isTouching = false;
    let touchDir = 0; // -1 Left, 1 Right

    function handleInputStart(x) {
        if (gameStatus !== "PLAYING" && gameStatus !== "SURVIVING") return;
        isTouching = true;
        touchDir = (x < width / 2) ? -1 : 1;
    }

    window.addEventListener('mousedown', (e) => handleInputStart(e.clientX));
    window.addEventListener('touchstart', (e) => handleInputStart(e.touches[0].clientX));
    window.addEventListener('mouseup', () => isTouching = false);
    window.addEventListener('touchend', () => isTouching = false);

    // Click pulsante start
    document.getElementById('action-btn').addEventListener('click', () => {
        initLevel(currentLevel);
    });


    // --- GAME LOOP ---
    Events.on(engine, 'beforeUpdate', function(event) {
        if (gameStatus !== "PLAYING" && gameStatus !== "SURVIVING") return;

        // 1. Input Fisica
        if (isTouching && tray) {
            // Applica forza angolare per ruotare
            Body.setAngularVelocity(tray, tray.angularVelocity + (0.0025 * touchDir));
        } else if (tray) {
            // Stabilizzazione passiva (smorzamento)
            Body.setAngularVelocity(tray, tray.angularVelocity * 0.94);
            
            // Auto-balance leggerissimo verso il centro (opzionale)
            const angleCorrection = -tray.angle * 0.005;
            Body.setAngularVelocity(tray, tray.angularVelocity + angleCorrection);
        }

        // Limiti rotazione fisica (clamp)
        if (tray) {
            if (tray.angle > 0.6) Body.setAngle(tray, 0.6);
            if (tray.angle < -0.6) Body.setAngle(tray, -0.6);
        }

        // 2. Controllo Caduta
        for (let i = 0; i < gameObjects.length; i++) {
            if (gameObjects[i].position.y > height + 50) {
                triggerGameOver();
                break;
            }
        }
    });

    // Avvio Motore
    Render.run(render);
    const runner = Runner.create();
    Runner.run(runner, engine);

</script>

</body>
</html>